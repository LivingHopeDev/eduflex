name: Deploy to Hostinger VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/new_vps_key
          chmod 600 ~/.ssh/new_vps_key
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/new_vps_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/new_vps_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} "echo SSH connection successful"

      - name: Deploy to VPS & Setup Nginx
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
          APP_NAME: "eduflex"
          DOMAIN_NAME: "yourdomain.com" # Change this if needed
          PORT: "3000" # Change this to match your app's port
        run: |
          ssh -o StrictHostKeyChecking=no $SERVER_USERNAME@$SERVER_HOST << 'EOF'
          set -x  # Print each command before executing
          echo "Deploying $APP_NAME to VPS..."

          # 1ï¸âƒ£ Navigate to project directory
          cd /root/$APP_NAME || { echo "âŒ Directory not found!"; exit 1; }

          # 2ï¸âƒ£ Pull latest changes
          echo "ðŸ”„ Pulling latest changes..."
          git pull origin main || { echo "âŒ Git pull failed!"; exit 1; }

          # 3ï¸âƒ£ Install dependencies
          echo "ðŸ“¦ Installing dependencies..."
          npm install --production || { echo "âŒ NPM install failed!"; exit 1; }

          # 4ï¸âƒ£ Restart app with PM2
          echo "ðŸš€ Restarting app with PM2..."
          pm2 restart $APP_NAME || pm2 start npm --name "$APP_NAME" -- run start
          pm2 save

          # 5ï¸âƒ£ Install Nginx if not installed
          if ! command -v nginx &> /dev/null; then
            echo "ðŸŒ Installing Nginx..."
            apt update && apt install -y nginx
          fi

          # 6ï¸âƒ£ Configure Nginx reverse proxy
          echo "ðŸ›  Setting up Nginx..."
          cat > /etc/nginx/sites-available/$APP_NAME <<EOL
          server {
              listen 80;
              server_name $SERVER_HOST;

              location / {
                  proxy_pass http://localhost:$PORT;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
                  proxy_cache_bypass \$http_upgrade;
              }
          }
          EOL

          ln -sf /etc/nginx/sites-available/$APP_NAME /etc/nginx/sites-enabled/
          nginx -t && systemctl restart nginx

          echo "âœ… Nginx setup complete!"
          EOF
