name: Deploy to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 --decode > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} "echo SSH connection successful"

      - name: Deploy to AWS EC2 & Setup Server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
          APP_NAME: "eduflex"
          GIT_REPO: "git@github.com:LivingHopeDev/eduflex.git"
          PORT: "3000"
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} << EOF
          set -x  # Print each command before executing
          echo "ðŸš€ Setting up AWS EC2 for deployment..."

          # 1ï¸âƒ£ Update system packages
          sudo apt update && sudo apt upgrade -y

          # 2ï¸âƒ£ Install required software
          echo "ðŸ“¦ Installing dependencies (Node.js, npm, PM2, Git, Nginx)..."
          sudo apt install -y git nginx curl unzip

          # 3ï¸âƒ£ Install Node.js (if missing)
          if ! command -v node &> /dev/null; then
            echo "ðŸŸ¢ Installing Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt install -y nodejs
          fi

          # 4ï¸âƒ£ Install PM2 globally
          npm install -g pm2

          # 5ï¸âƒ£ Clone repo if not present
          if [ ! -d "/home/${SERVER_USERNAME}/eduflex/.git" ]; then
            echo "ðŸ“¥ Cloning repository..."
            git clone ${GIT_REPO} /home/${SERVER_USERNAME}/eduflex || { echo "âŒ Git clone failed!"; exit 1; }
          fi

          cd /home/${SERVER_USERNAME}/eduflex || { echo "âŒ Directory not found!"; exit 1; }

          # 6ï¸âƒ£ Pull latest changes
          echo "ðŸ”„ Pulling latest changes..."
          git pull origin main || { echo "âŒ Git pull failed!"; exit 1; }

          # 7ï¸âƒ£ Install Node.js dependencies
          echo "ðŸ“¦ Installing dependencies..."
          npm install --production || { echo "âŒ NPM install failed!"; exit 1; }

          # 8ï¸âƒ£ Start/Restart app with PM2
          echo "ðŸš€ Starting app with PM2..."
          pm2 restart eduflex || pm2 start npm --name "eduflex" -- run start
          pm2 save
          pm2 startup systemd

          # 9ï¸âƒ£ Set up Nginx Reverse Proxy
          echo "ðŸ›  Configuring Nginx..."
          sudo tee /etc/nginx/sites-available/eduflex > /dev/null <<EOL
          server {
              listen 80;
              server_name _;

              location / {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host \$host;
                  proxy_cache_bypass \$http_upgrade;
              }
          }
          EOL

          sudo ln -sf /etc/nginx/sites-available/eduflex /etc/nginx/sites-enabled/
          sudo nginx -t && sudo systemctl restart nginx

          # ðŸ”Ÿ Allow firewall rules
          echo "ðŸ”’ Configuring firewall..."
          sudo ufw allow OpenSSH
          sudo ufw allow 'Nginx Full'
          sudo ufw allow ${PORT}
          sudo ufw --force enable

          echo "âœ… Deployment complete!"
          EOF
